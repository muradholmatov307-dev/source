local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local CSGUI = {}

function CSGUI.Create(config)
    config = config or {}
    
    local player = Players.LocalPlayer
    local gui = Instance.new("ScreenGui")
    gui.Name = config.Name or "CS_Style_GUI"
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    gui.Parent = player:WaitForChild("PlayerGui")

    -- Основной контейнер
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = config.Size or UDim2.new(0, 500, 0, 600)
    mainFrame.Position = config.Position or UDim2.new(0.5, 0, 0.5, 0)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    mainFrame.BorderSizePixel = 0
    mainFrame.ClipsDescendants = true
    mainFrame.Parent = gui

    -- Тень
    local shadow = Instance.new("ImageLabel")
    shadow.Name = "Shadow"
    shadow.Size = UDim2.new(1, 10, 1, 10)
    shadow.Position = UDim2.new(0, -5, 0, -5)
    shadow.BackgroundTransparency = 1
    shadow.Image = "rbxassetid://1316045217"
    shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
    shadow.ImageTransparency = 0.8
    shadow.ScaleType = Enum.ScaleType.Slice
    shadow.SliceCenter = Rect.new(10, 10, 118, 118)
    shadow.Parent = mainFrame

    -- Заголовок
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.Size = UDim2.new(1, 0, 0, 40)
    header.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    header.BorderSizePixel = 0
    header.Parent = mainFrame

    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -40, 1, 0)
    title.Position = UDim2.new(0, 20, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = config.Title or "CS CONTROL PANEL"
    title.TextColor3 = Color3.fromRGB(220, 220, 220)
    title.TextSize = 16
    title.Font = Enum.Font.GothamBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = header

    -- Кнопка закрытия
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 40, 1, 0)
    closeButton.Position = UDim2.new(1, -40, 0, 0)
    closeButton.BackgroundTransparency = 1
    closeButton.Text = "×"
    closeButton.TextColor3 = Color3.fromRGB(200, 200, 200)
    closeButton.TextSize = 20
    closeButton.Font = Enum.Font.GothamBold
    closeButton.Parent = header

    -- Контейнер для вкладок
    local tabContainer = Instance.new("Frame")
    tabContainer.Name = "TabContainer"
    tabContainer.Size = UDim2.new(1, 0, 0, 50)
    tabContainer.Position = UDim2.new(0, 0, 0, 40)
    tabContainer.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    tabContainer.BorderSizePixel = 0
    tabContainer.Parent = mainFrame

    -- Контейнер для контента
    local contentContainer = Instance.new("Frame")
    contentContainer.Name = "ContentContainer"
    contentContainer.Size = UDim2.new(1, -40, 1, -90)
    contentContainer.Position = UDim2.new(0, 20, 0, 90)
    contentContainer.BackgroundTransparency = 1
    contentContainer.Parent = mainFrame

    local self = {
        GUI = gui,
        MainFrame = mainFrame,
        Tabs = {},
        CurrentTab = 1,
        Elements = {}
    }

    -- Функция для создания вкладки
    function self.CreateTab(tabName)
        local tabIndex = #self.Tabs + 1
        
        local tabButton = Instance.new("TextButton")
        tabButton.Name = tabName .. "Tab"
        tabButton.Size = UDim2.new(1 / math.max(#self.Tabs + 1, 1), 0, 1, 0)
        tabButton.Position = UDim2.new((1 / math.max(#self.Tabs + 1, 1)) * (tabIndex - 1), 0, 0, 0)
        tabButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        tabButton.BorderSizePixel = 0
        tabButton.Text = tabName
        tabButton.TextColor3 = Color3.fromRGB(150, 150, 150)
        tabButton.TextSize = 12
        tabButton.Font = Enum.Font.Gotham
        tabButton.Parent = tabContainer
        
        local highlight = Instance.new("Frame")
        highlight.Name = "Highlight"
        highlight.Size = UDim2.new(1, 0, 0, 2)
        highlight.Position = UDim2.new(0, 0, 1, -2)
        highlight.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
        highlight.BorderSizePixel = 0
        highlight.Visible = tabIndex == 1
        highlight.Parent = tabButton

        local tabContent = Instance.new("ScrollingFrame")
        tabContent.Name = tabName .. "Tab"
        tabContent.Size = UDim2.new(1, 0, 1, 0)
        tabContent.BackgroundTransparency = 1
        tabContent.ScrollBarThickness = 3
        tabContent.ScrollBarImageColor3 = Color3.fromRGB(80, 80, 80)
        tabContent.Visible = tabIndex == 1
        tabContent.Parent = contentContainer

        local uiListLayout = Instance.new("UIListLayout")
        uiListLayout.Padding = UDim.new(0, 8)
        uiListLayout.Parent = tabContent

        local tabData = {
            Name = tabName,
            Button = tabButton,
            Content = tabContent,
            Layout = uiListLayout,
            Elements = {}
        }

        table.insert(self.Tabs, tabData)

        -- Обновляем размеры кнопок вкладок
        for i, tab in ipairs(self.Tabs) do
            tab.Button.Size = UDim2.new(1 / #self.Tabs, 0, 1, 0)
            tab.Button.Position = UDim2.new((1 / #self.Tabs) * (i - 1), 0, 0, 0)
        end

        tabButton.MouseButton1Click:Connect(function()
            self.CurrentTab = tabIndex
            for i, tab in ipairs(self.Tabs) do
                tab.Button.TextColor3 = i == tabIndex and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(150, 150, 150)
                tab.Button.Highlight.Visible = i == tabIndex
                tab.Content.Visible = i == tabIndex
            end
        end)

        tabButton.MouseEnter:Connect(function()
            if self.CurrentTab ~= tabIndex then
                tabButton.TextColor3 = Color3.fromRGB(200, 200, 200)
            end
        end)

        tabButton.MouseLeave:Connect(function()
            if self.CurrentTab ~= tabIndex then
                tabButton.TextColor3 = Color3.fromRGB(150, 150, 150)
            end
        end)

        return tabData
    end

    -- Функция для создания переключателя
    function self.CreateToggle(name, defaultValue, tab)
        local toggleFrame = Instance.new("Frame")
        toggleFrame.Name = name .. "Toggle"
        toggleFrame.Size = UDim2.new(1, 0, 0, 35)
        toggleFrame.BackgroundTransparency = 1
        toggleFrame.Parent = tab.Content
        
        local label = Instance.new("TextLabel")
        label.Name = "Label"
        label.Size = UDim2.new(0.7, 0, 1, 0)
        label.Position = UDim2.new(0, 0, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = name
        label.TextColor3 = Color3.fromRGB(220, 220, 220)
        label.TextSize = 14
        label.Font = Enum.Font.Gotham
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = toggleFrame
        
        local toggleButton = Instance.new("TextButton")
        toggleButton.Name = "ToggleButton"
        toggleButton.Size = UDim2.new(0, 50, 0, 20)
        toggleButton.Position = UDim2.new(1, -50, 0.5, -10)
        toggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        toggleButton.BorderSizePixel = 0
        toggleButton.Text = ""
        toggleButton.Parent = toggleFrame
        
        local toggleKnob = Instance.new("Frame")
        toggleKnob.Name = "ToggleKnob"
        toggleKnob.Size = UDim2.new(0, 16, 0, 16)
        toggleKnob.Position = UDim2.new(0, 2, 0.5, -8)
        toggleKnob.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
        toggleKnob.BorderSizePixel = 0
        toggleKnob.Parent = toggleButton
        
        local state = defaultValue
        
        local function updateToggle()
            if state then
                TweenService:Create(toggleKnob, TweenInfo.new(0.2), {Position = UDim2.new(1, -18, 0.5, -8)}):Play()
                TweenService:Create(toggleButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(0, 120, 215)}):Play()
            else
                TweenService:Create(toggleKnob, TweenInfo.new(0.2), {Position = UDim2.new(0, 2, 0.5, -8)}):Play()
                TweenService:Create(toggleButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 60)}):Play()
            end
        end
        
        toggleButton.MouseButton1Click:Connect(function()
            state = not state
            updateToggle()
        end)
        
        updateToggle()
        
        local toggleObj = {
            GetValue = function() return state end,
            SetValue = function(value)
                state = value
                updateToggle()
            end
        }
        
        table.insert(self.Elements, {Name = name, Type = "Toggle", Object = toggleObj})
        table.insert(tab.Elements, {Name = name, Type = "Toggle", Object = toggleObj})
        
        return toggleObj
    end

    -- Функция для создания слайдера
    function self.CreateSlider(name, minValue, maxValue, defaultValue, tab)
        local sliderFrame = Instance.new("Frame")
        sliderFrame.Name = name .. "Slider"
        sliderFrame.Size = UDim2.new(1, 0, 0, 55)
        sliderFrame.BackgroundTransparency = 1
        sliderFrame.Parent = tab.Content
        
        local label = Instance.new("TextLabel")
        label.Name = "Label"
        label.Size = UDim2.new(1, 0, 0, 20)
        label.Position = UDim2.new(0, 0, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = name .. ": " .. defaultValue
        label.TextColor3 = Color3.fromRGB(220, 220, 220)
        label.TextSize = 14
        label.Font = Enum.Font.Gotham
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = sliderFrame
        
        local track = Instance.new("Frame")
        track.Name = "Track"
        track.Size = UDim2.new(1, 0, 0, 4)
        track.Position = UDim2.new(0, 0, 1, -20)
        track.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        track.BorderSizePixel = 0
        track.Parent = sliderFrame
        
        local fill = Instance.new("Frame")
        fill.Name = "Fill"
        fill.Size = UDim2.new((defaultValue - minValue) / (maxValue - minValue), 0, 1, 0)
        fill.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
        fill.BorderSizePixel = 0
        fill.Parent = track
        
        local knob = Instance.new("TextButton")
        knob.Name = "Knob"
        knob.Size = UDim2.new(0, 12, 0, 12)
        knob.Position = UDim2.new((defaultValue - minValue) / (maxValue - minValue), -6, 0.5, -6)
        knob.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
        knob.BorderSizePixel = 0
        knob.Text = ""
        knob.ZIndex = 2
        knob.Parent = track
        
        local value = defaultValue
        local dragging = false
        
        local function updateSlider(newValue)
            value = math.clamp(newValue, minValue, maxValue)
            local ratio = (value - minValue) / (maxValue - minValue)
            fill.Size = UDim2.new(ratio, 0, 1, 0)
            knob.Position = UDim2.new(ratio, -6, 0.5, -6)
            label.Text = name .. ": " .. string.format("%.1f", value)
        end
        
        knob.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        UserInputService.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local mousePos = UserInputService:GetMouseLocation()
                local absolutePosition = track.AbsolutePosition
                local absoluteSize = track.AbsoluteSize
                local relativeX = (mousePos.X - absolutePosition.X) / absoluteSize.X
                local newValue = minValue + (maxValue - minValue) * math.clamp(relativeX, 0, 1)
                updateSlider(newValue)
            end
        end)
        
        updateSlider(defaultValue)
        
        local sliderObj = {
            GetValue = function() return value end,
            SetValue = function(newValue) updateSlider(newValue) end
        }
        
        table.insert(self.Elements, {Name = name, Type = "Slider", Object = sliderObj})
        table.insert(tab.Elements, {Name = name, Type = "Slider", Object = sliderObj})
        
        return sliderObj
    end

    -- Функция для создания выпадающего списка
    function self.CreateDropdown(name, options, defaultOption, tab)
        local dropdownFrame = Instance.new("Frame")
        dropdownFrame.Name = name .. "Dropdown"
        dropdownFrame.Size = UDim2.new(1, 0, 0, 35)
        dropdownFrame.BackgroundTransparency = 1
        dropdownFrame.ClipsDescendants = true
        dropdownFrame.Parent = tab.Content
        
        local label = Instance.new("TextLabel")
        label.Name = "Label"
        label.Size = UDim2.new(0.7, 0, 1, 0)
        label.Position = UDim2.new(0, 0, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = name
        label.TextColor3 = Color3.fromRGB(220, 220, 220)
        label.TextSize = 14
        label.Font = Enum.Font.Gotham
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = dropdownFrame
        
        local dropdownButton = Instance.new("TextButton")
        dropdownButton.Name = "DropdownButton"
        dropdownButton.Size = UDim2.new(0.3, 0, 1, 0)
        dropdownButton.Position = UDim2.new(0.7, 0, 0, 0)
        dropdownButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        dropdownButton.BorderSizePixel = 0
        dropdownButton.Text = defaultOption
        dropdownButton.TextColor3 = Color3.fromRGB(220, 220, 220)
        dropdownButton.TextSize = 12
        dropdownButton.Font = Enum.Font.Gotham
        dropdownButton.Parent = dropdownFrame
        
        local dropdownList = Instance.new("ScrollingFrame")
        dropdownList.Name = "DropdownList"
        dropdownList.Size = UDim2.new(1, 0, 0, 0)
        dropdownList.Position = UDim2.new(0, 0, 1, 2)
        dropdownList.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        dropdownList.BorderSizePixel = 0
        dropdownList.ScrollBarThickness = 3
        dropdownList.ScrollBarImageColor3 = Color3.fromRGB(80, 80, 80)
        dropdownList.Visible = false
        dropdownList.Parent = dropdownFrame
        
        local uiListLayout = Instance.new("UIListLayout")
        uiListLayout.Parent = dropdownList
        
        local selectedOption = defaultOption
        local isOpen = false
        
        local function toggleDropdown()
            isOpen = not isOpen
            if isOpen then
                dropdownList.Size = UDim2.new(1, 0, 0, math.min(#options * 25, 125))
                dropdownList.Visible = true
            else
                dropdownList.Size = UDim2.new(1, 0, 0, 0)
                dropdownList.Visible = false
            end
        end
        
        local function selectOption(option)
            selectedOption = option
            dropdownButton.Text = option
            toggleDropdown()
        end
        
        -- Создаем элементы списка
        for _, option in ipairs(options) do
            local optionButton = Instance.new("TextButton")
            optionButton.Size = UDim2.new(1, 0, 0, 25)
            optionButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            optionButton.BorderSizePixel = 0
            optionButton.Text = option
            optionButton.TextColor3 = Color3.fromRGB(220, 220, 220)
            optionButton.TextSize = 12
            optionButton.Font = Enum.Font.Gotham
            optionButton.Parent = dropdownList
            
            optionButton.MouseButton1Click:Connect(function()
                selectOption(option)
            end)
            
            optionButton.MouseEnter:Connect(function()
                optionButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
            end)
            
            optionButton.MouseLeave:Connect(function()
                optionButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            end)
        end
        
        dropdownButton.MouseButton1Click:Connect(toggleDropdown)
        
        local dropdownObj = {
            GetValue = function() return selectedOption end,
            SetValue = function(value)
                if table.find(options, value) then
                    selectOption(value)
                end
            end
        }
        
        table.insert(self.Elements, {Name = name, Type = "Dropdown", Object = dropdownObj})
        table.insert(tab.Elements, {Name = name, Type = "Dropdown", Object = dropdownObj})
        
        return dropdownObj
    end

    -- Функция для создания кнопки
    function self.CreateButton(name, tab, callback)
        local button = Instance.new("TextButton")
        button.Name = name .. "Button"
        button.Size = UDim2.new(1, 0, 0, 35)
        button.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
        button.BorderSizePixel = 0
        button.Text = name
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.TextSize = 14
        button.Font = Enum.Font.GothamBold
        button.Parent = tab.Content
        
        button.MouseButton1Click:Connect(function()
            if callback then
                callback()
            end
        end)
        
        local buttonObj = {
            SetText = function(text) button.Text = text end,
            SetColor = function(color) button.BackgroundColor3 = color end
        }
        
        table.insert(self.Elements, {Name = name, Type = "Button", Object = buttonObj})
        table.insert(tab.Elements, {Name = name, Type = "Button", Object = buttonObj})
        
        return buttonObj
    end

    -- Функция для создания цветового пикера
    function self.CreateColorPicker(name, defaultColor, tab)
        local colorPickerFrame = Instance.new("Frame")
        colorPickerFrame.Name = name .. "ColorPicker"
        colorPickerFrame.Size = UDim2.new(1, 0, 0, 35)
        colorPickerFrame.BackgroundTransparency = 1
        colorPickerFrame.Parent = tab.Content
        
        local label = Instance.new("TextLabel")
        label.Name = "Label"
        label.Size = UDim2.new(0.7, 0, 1, 0)
        label.Position = UDim2.new(0, 0, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = name
        label.TextColor3 = Color3.fromRGB(220, 220, 220)
        label.TextSize = 14
        label.Font = Enum.Font.Gotham
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = colorPickerFrame
        
        local colorButton = Instance.new("TextButton")
        colorButton.Name = "ColorButton"
        colorButton.Size = UDim2.new(0, 60, 0, 20)
        colorButton.Position = UDim2.new(1, -60, 0.5, -10)
        colorButton.BackgroundColor3 = defaultColor
        colorButton.BorderSizePixel = 0
        colorButton.Text = ""
        colorButton.Parent = colorPickerFrame
        
        local selectedColor = defaultColor
        
        colorButton.MouseButton1Click:Connect(function()
            selectedColor = Color3.new(math.random(), math.random(), math.random())
            colorButton.BackgroundColor3 = selectedColor
        end)
        
        local colorPickerObj = {
            GetValue = function() return selectedColor end,
            SetValue = function(color) 
                selectedColor = color
                colorButton.BackgroundColor3 = color
            end
        }
        
        table.insert(self.Elements, {Name = name, Type = "ColorPicker", Object = colorPickerObj})
        table.insert(tab.Elements, {Name = name, Type = "ColorPicker", Object = colorPickerObj})
        
        return colorPickerObj
    end

    -- Делаем GUI перетаскиваемым
    local dragging = false
    local dragInput
    local dragStart
    local startPos

    local function update(input)
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    header.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    header.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)

    -- Обработчик закрытия
    closeButton.MouseButton1Click:Connect(function()
        gui:Destroy()
    end)

    closeButton.MouseEnter:Connect(function()
        closeButton.TextColor3 = Color3.fromRGB(255, 80, 80)
    end)

    closeButton.MouseLeave:Connect(function()
        closeButton.TextColor3 = Color3.fromRGB(200, 200, 200)
    end)

    -- Автоматическое обновление размеров списков
    game:GetService("RunService").Heartbeat:Connect(function()
        for _, tab in ipairs(self.Tabs) do
            tab.Content.CanvasSize = UDim2.new(0, 0, 0, tab.Layout.AbsoluteContentSize.Y)
        end
    end)

    -- Метод для уничтожения GUI
    function self.Destroy()
        gui:Destroy()
    end

    -- Метод для получения всех элементов
    function self.GetElements()
        return self.Elements
    end

    -- Метод для получения элемента по имени
    function self.GetElement(name)
        for _, element in ipairs(self.Elements) do
            if element.Name == name then
                return element.Object
            end
        end
        return nil
    end

    return self
end

return CSGUI
