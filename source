-- FurstyHub Core Library
local FurstyHub = {}

-- Защита от копирования
if getgenv().FurstyHubLoaded then
    return nil
end
getgenv().FurstyHubLoaded = true

-- Проверяем что игра загружена
if not game:IsLoaded() then
    game.Loaded:Wait()
end

-- Key System
local KeySystem = {
    Enabled = false,
    ValidKeys = {},
    KeyURL = nil,
    CurrentKey = nil
}

-- Функция для настройки Key System
function FurstyHub:SetupKeySystem(keys, keyURL)
    KeySystem.Enabled = true
    KeySystem.ValidKeys = keys
    KeySystem.KeyURL = keyURL
end

-- Функция проверки ключа
local function ValidateKey(key)
    if not KeySystem.Enabled then return true end
    
    for _, validKey in pairs(KeySystem.ValidKeys) do
        if key == validKey then
            KeySystem.CurrentKey = key
            return true
        end
    end
    
    return false
end

-- Функция получения ключей с сервера
local function FetchKeysFromServer()
    if not KeySystem.KeyURL then return {} end
    
    local success, result = pcall(function()
        return game:HttpGet(KeySystem.KeyURL)
    end)
    
    if success and result then
        local keys = {}
        for key in string.gmatch(result, '[%w%-]+') do
            table.insert(keys, key)
        end
        return keys
    end
    
    return {}
end

-- Функция создания GUI с Key System
function FurstyHub:CreateGUI(config)
    -- Проверяем Key System
    if KeySystem.Enabled and not KeySystem.CurrentKey then
        -- Создаем GUI для ввода ключа
        local KeyGUI = Instance.new("ScreenGui")
        local MainFrame = Instance.new("Frame")
        local UICorner = Instance.new("UICorner")
        local Title = Instance.new("TextLabel")
        local InputBox = Instance.new("TextBox")
        local SubmitButton = Instance.new("TextButton")
        local MessageLabel = Instance.new("TextLabel")
        
        KeyGUI.Name = "KeySystemGUI"
        KeyGUI.Parent = game.CoreGui
        KeyGUI.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        
        MainFrame.Name = "MainFrame"
        MainFrame.Parent = KeyGUI
        MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
        MainFrame.Position = UDim2.new(0.4, 0, 0.4, 0)
        MainFrame.Size = UDim2.new(0, 300, 0, 200)
        
        UICorner.CornerRadius = UDim.new(0, 12)
        UICorner.Parent = MainFrame
        
        Title.Name = "Title"
        Title.Parent = MainFrame
        Title.BackgroundTransparency = 1
        Title.Position = UDim2.new(0, 0, 0.1, 0)
        Title.Size = UDim2.new(1, 0, 0, 30)
        Title.Font = Enum.Font.GothamBold
        Title.Text = config.Name .. " Key System"
        Title.TextColor3 = Color3.fromRGB(255, 255, 255)
        Title.TextSize = 18
        
        InputBox.Name = "InputBox"
        InputBox.Parent = MainFrame
        InputBox.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        InputBox.Position = UDim2.new(0.1, 0, 0.4, 0)
        InputBox.Size = UDim2.new(0.8, 0, 0, 35)
        InputBox.Font = Enum.Font.Gotham
        InputBox.PlaceholderText = "Enter your key..."
        InputBox.Text = ""
        InputBox.TextColor3 = Color3.fromRGB(255, 255, 255)
        InputBox.TextSize = 14
        
        local InputCorner = Instance.new("UICorner")
        InputCorner.CornerRadius = UDim.new(0, 8)
        InputCorner.Parent = InputBox
        
        SubmitButton.Name = "SubmitButton"
        SubmitButton.Parent = MainFrame
        SubmitButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        SubmitButton.Position = UDim2.new(0.25, 0, 0.7, 0)
        SubmitButton.Size = UDim2.new(0.5, 0, 0, 35)
        SubmitButton.Font = Enum.Font.GothamBold
        SubmitButton.Text = "SUBMIT KEY"
        SubmitButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        SubmitButton.TextSize = 14
        
        local ButtonCorner = Instance.new("UICorner")
        ButtonCorner.CornerRadius = UDim.new(0, 8)
        ButtonCorner.Parent = SubmitButton
        
        MessageLabel.Name = "MessageLabel"
        MessageLabel.Parent = MainFrame
        MessageLabel.BackgroundTransparency = 1
        MessageLabel.Position = UDim2.new(0, 0, 0.85, 0)
        MessageLabel.Size = UDim2.new(1, 0, 0, 20)
        MessageLabel.Font = Enum.Font.Gotham
        MessageLabel.Text = "Get key from Discord"
        MessageLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
        MessageLabel.TextSize = 12
        
        -- Обновляем ключи с сервера
        spawn(function()
            local serverKeys = FetchKeysFromServer()
            if #serverKeys > 0 then
                for _, key in pairs(serverKeys) do
                    table.insert(KeySystem.ValidKeys, key)
                end
            end
        end)
        
        -- Обработчик кнопки
        SubmitButton.MouseButton1Click:Connect(function()
            local key = InputBox.Text:gsub("%s+", "")
            
            if ValidateKey(key) then
                MessageLabel.Text = "✅ Key accepted!"
                MessageLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
                
                wait(1)
                KeyGUI:Destroy()
                
                -- Создаем основной GUI после успешной проверки
                return CreateMainGUI(config)
            else
                MessageLabel.Text = "❌ Invalid key!"
                MessageLabel.TextColor3 = Color3.fromRGB(255, 50, 50)
            end
        end)
        
        -- Копирование Discord по клику
        MessageLabel.MouseButton1Click:Connect(function()
            if config.Discord then
                setclipboard(config.Discord)
                MessageLabel.Text = "✅ Discord copied!"
                wait(2)
                MessageLabel.Text = "Get key from Discord"
            end
        end)
        
        return nil
    end
    
    -- Если Key System отключен или ключ уже проверен
    return CreateMainGUI(config)
end

-- Основная функция создания GUI (перенеси сюда весь твой существующий код)
local function CreateMainGUI(config)
    if not config then config = {} end
    
    config.Name = config.Name or "FurstyHub"
    config.Version = config.Version or "1.0"
    config.Discord = config.Discord or "dsc.gg/furstyhub"
    config.WatermarkEnabled = config.WatermarkEnabled == nil and true or config.WatermarkEnabled

    local GUI = {}
    local WatermarkEnabled = config.WatermarkEnabled
    
    -- Watermark система
    local function UpdateWatermark()
        if not WatermarkEnabled then return end
        
        if game:GetService("CoreGui"):FindFirstChild(config.Name .. "Watermark") then
            game:GetService("CoreGui")[config.Name .. "Watermark"]:Destroy()
        end
        
        local WatermarkGui = Instance.new("ScreenGui")
        local WatermarkFrame = Instance.new("Frame")
        local UICorner = Instance.new("UICorner")
        local Stroke = Instance.new("UIStroke")
        local FIcon = Instance.new("TextLabel")
        local TextLabel = Instance.new("TextLabel")
        
        WatermarkGui.Name = config.Name .. "Watermark"
        WatermarkGui.Parent = game.CoreGui
        WatermarkGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        
        WatermarkFrame.Name = "WatermarkFrame"
        WatermarkFrame.Parent = WatermarkGui
        WatermarkFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
        WatermarkFrame.Position = UDim2.new(0.75, 0, 0.02, 0)
        WatermarkFrame.Size = UDim2.new(0, 200, 0, 40)
        
        UICorner.CornerRadius = UDim.new(0, 8)
        UICorner.Parent = WatermarkFrame
        
        Stroke.Parent = WatermarkFrame
        Stroke.Color = Color3.fromRGB(255, 50, 50)
        Stroke.Thickness = 2
        Stroke.Transparency = 0.3
        
        FIcon.Name = "FIcon"
        FIcon.Parent = WatermarkFrame
        FIcon.BackgroundTransparency = 1
        FIcon.Position = UDim2.new(0.02, 0, 0.1, 0)
        FIcon.Size = UDim2.new(0, 25, 0, 25)
        FIcon.Font = Enum.Font.GothamBlack
        FIcon.Text = "F"
        FIcon.TextColor3 = Color3.fromRGB(255, 50, 50)
        FIcon.TextSize = 18
        
        TextLabel.Parent = WatermarkFrame
        TextLabel.BackgroundTransparency = 1
        TextLabel.Position = UDim2.new(0.15, 0, 0.1, 0)
        TextLabel.Size = UDim2.new(0, 120, 0, 15)
        TextLabel.Font = Enum.Font.GothamBold
        TextLabel.Text = config.Name .. " | " .. config.Version
        TextLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        TextLabel.TextSize = 12
        TextLabel.TextXAlignment = Enum.TextXAlignment.Left
        
        -- Анимация обводки
        spawn(function()
            while WatermarkEnabled and WatermarkGui and WatermarkGui.Parent do
                for i = 1, 10 do
                    if not WatermarkGui or not WatermarkGui.Parent then break end
                    local alpha = 0.3 + (i * 0.07)
                    Stroke.Transparency = 1 - alpha
                    wait(0.05)
                end
                for i = 1, 10 do
                    if not WatermarkGui or not WatermarkGui.Parent then break end
                    local alpha = 1.0 - (i * 0.07)
                    Stroke.Transparency = 1 - alpha
                    wait(0.05)
                end
            end
        end)
    end
    
    -- ОСТАЛЬНОЙ КОД ТВОЕЙ БИБЛИОТЕКИ...
    -- (вставь сюда весь твой существующий код из CreateGUI функции)
    
    -- Главный фрейм, вкладки, элементы и т.д.
    local ScreenGui = Instance.new("ScreenGui")
    local MainFrame = Instance.new("Frame")
    -- ... остальной код
    
    spawn(function()
        wait(1)
        UpdateWatermark()
    end)

    return GUI
end

return FurstyHub
